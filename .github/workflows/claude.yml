name: Claude

on:
  schedule:
    - cron: 0 * * * *
  workflow_dispatch:

jobs:
  trigger:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: write
    steps:
      - uses: szenius/set-timezone@v2.0
        with:
          timezoneLinux: "Asia/Shanghai"
      - uses: actions/checkout@v6
      - name: Trigger Claude
        id: claude
        uses: anthropics/claude-code-action@v1
        continue-on-error: true
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: 1+1
          claude_args: --model haiku --max-turns 1 --system-prompt "Result only" --tools "" --disable-slash-commands
      - uses: actions/upload-artifact@v6
        with:
          path: ${{ steps.claude.outputs.execution_file }}

      - name: Parse result
        id: result
        env:
          EXECUTION_FILE: ${{ steps.claude.outputs.execution_file }}
          OUTCOME: ${{ steps.claude.outcome }}
        run: |
          if [ "$OUTCOME" == "success" ]; then
            echo "success=true" >> $GITHUB_OUTPUT
            echo "message=" >> $GITHUB_OUTPUT
          else
            MESSAGE=""
            if [ -n "${EXECUTION_FILE:-}" ] && [ -f "$EXECUTION_FILE" ]; then
              MESSAGE=$(jq -r 'if type == "array" then .[] else . end | select(.type == "result") | .result // empty' "$EXECUTION_FILE" | tail -1)
            fi
            echo "success=false" >> $GITHUB_OUTPUT
            echo "message=$MESSAGE" >> $GITHUB_OUTPUT
          fi

      - name: Checkout gh-pages
        run: |
          git fetch origin gh-pages:gh-pages
          git checkout gh-pages

      - name: Fetch template from master
        run: |
          git checkout origin/master -- templates/README.mustache

      - name: Update status with jq
        env:
          SUCCESS: ${{ steps.result.outputs.success }}
          MESSAGE: ${{ steps.result.outputs.message }}
        run: |
          [ -f status.json ] || echo '{"services":[]}' > status.json
          jq --arg key "claude" \
             --arg name "Claude" \
             --arg badge "${{ github.server_url }}/${{ github.repository }}/actions/workflows/claude.yml/badge.svg" \
             --arg usage "https://claude.ai/settings/usage" \
             --argjson success "$SUCCESS" \
             --arg timestamp "$(date +'%Y-%m-%d %H:%M:%S')" \
             --arg job_url "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
             --arg message "$MESSAGE" \
             '(.services |= ([{
               key: $key, name: $name, badge_url: $badge, usage_url: $usage,
               success: $success, timestamp: $timestamp, job_url: $job_url, message: $message
             }] + map(select(.key != $key))))' status.json > tmp.json && mv tmp.json status.json

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: latest

      - name: Render README with mustache
        run: npx mustache status.json templates/README.mustache > README.md

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add status.json README.md
          if ! git diff --staged --quiet; then
            git commit -m "Update Claude status"
            git push origin gh-pages
          fi

      - name: Fail on error
        env:
          SUCCESS: ${{ steps.result.outputs.success }}
          MESSAGE: ${{ steps.result.outputs.message }}
        if: env.SUCCESS != 'true'
        run: |
          if [[ "$MESSAGE" != *"Spending cap reached"* ]]; then
            echo "::error::Claude failed: $MESSAGE"
            exit 1
          fi
